## Deploy a production environment using Nginx

- name: install nginx
  apt:
    name: nginx-full
    state: present
    force: yes
  become: true

- name: copy gunicorn template
  template: src={{ corr_path }}/builds/app_config.py.j2 dest={{ gunicorn_config }}

- name: copy service template
  template: src={{ corr_path }}/builds/app.service.j2 dest=/lib/systemd/system/{{ app_service_name }}.service
  become: true

- name: update systemd
  command: systemctl daemon-reload
  become: true

- name: run server
  service: name={{ app_service_name }} state=restarted
  become: true

- name: copy nginx template
  template: src={{ corr_path }}/builds/nginx-app.j2 dest=/etc/nginx/sites-available/{{ app_service_name }}
  become: true

- name: link files for nginx
  file: src=/etc/nginx/sites-available/corr dest=/etc/nginx/sites-enabled/corr state=link
  become: true

- name: restart nginx
  service: name=nginx state=restarted
  become: true

- name: check that app is up and running
  uri: url={{ test_path }}
